<!DOCTYPE html>
<html lang="en"> 
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>One‚ÄëTap Bird Logger</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#93a0b3; --text:#eaf2ff; --accent:#5cc8ff; --ok:#25d366; --warn:#ffb020; --danger:#ff5c5c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg); color:var(--text);
    }
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(11,18,32,.95), rgba(11,18,32,.75)); backdrop-filter: blur(6px);
      border-bottom:1px solid #223049}
    .wrap{max-width:880px; margin:0 auto; padding:12px}
    h1{font-size:20px; margin:6px 0}
    #status{font-size:12px; color:var(--muted)}

    .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    @media (min-width:480px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (min-width:720px){.grid{grid-template-columns:repeat(4,1fr)}}

    .card{background:var(--card); border:1px solid #223049; border-radius:16px; padding:12px; box-shadow: 0 4px 14px rgba(0,0,0,.25)}
    .row{display:flex; gap:8px; align-items:center}
    .row-grow{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .chip{font-size:12px; color:var(--muted)}

    button{
      border:none; border-radius:14px; padding:14px 16px; font-weight:600; font-size:16px; cursor:pointer;
      background:#1a2843; color:var(--text); border:1px solid #2a3b5f; box-shadow: 0 3px 10px rgba(0,0,0,.3);
      touch-action: manipulation;
    }
    button.big{font-size:18px; padding:18px 16px}
    button:active{transform:translateY(1px)}
    .btn-accent{background:#0b2a3a; border-color:#0c4864}
    .btn-ok{background:#0e3d2d; border-color:#1d6c52}
    .btn-warn{background:#3a300b; border-color:#6b571d}
    .btn-danger{background:#3a0b0b; border-color:#6b1d1d}

    .species-btn{display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%;}
    .species-name{font-size:17px; font-weight:700; text-align:left}
    .count-badge{font-size:12px; background:#0e213a; padding:6px 10px; border-radius:999px; border:1px solid #2a3b5f}

    .toolbar{position:sticky; bottom:0; z-index:10; background:linear-gradient(0deg, rgba(11,18,32,.95), rgba(11,18,32,.6)); border-top:1px solid #223049}
    .toolbar .wrap{display:flex; gap:8px}
    .toolbar button{flex:1}

    input, textarea{
      width:100%; background:#0f1728; border:1px solid #2a3b5f; color:var(--text); border-radius:12px; padding:12px; font-size:14px;
    }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}

    .toast{position:fixed; left:50%; bottom:84px; transform:translateX(-50%);
      background:#0e213a; border:1px solid #2a3b5f; padding:10px 14px; border-radius:999px; font-size:14px; display:none}

    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid #243149; padding:8px 6px; font-size:12px}
    th{color:#a8b4c6; text-align:left}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .pill{padding:4px 8px; border:1px solid #2a3b5f; border-radius:999px; font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap row-grow">
      <div>
        <h1>One‚ÄëTap Bird Logger</h1>
        <div id="status">Ready. GPS: <span id="gpsStatus">off</span></div>
      </div>
      <div class="row">
        <button id="micBtn" title="Voice log (press to speak)">üéôÔ∏è Voice</button>
        <button id="addBtn" class="btn-accent" title="Add a species button">Ôºã Add</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="app">
    <section class="card" aria-label="Tips">
      <div class="row-grow">
        <div class="chip">Tap a species to log one sighting with GPS & time. Long‚Äëpress to subtract.</div>
        <div class="pill" id="accPill" title="Last GPS accuracy">¬±‚Äì m</div>
      </div>
    </section>

    <section class="grid" id="speciesGrid" aria-label="Species buttons">
      <!-- Species buttons injected here -->
    </section>

    <section class="card" style="margin-top:14px">
      <div class="row-grow" style="margin-bottom:8px">
        <strong>Logs</strong>
        <div class="row">
          <button id="exportBtn" class="btn-ok">Export CSV</button>
          <button id="copyBtn" class="btn-ok" title="Copy CSV to clipboard">Copy CSV</button>
          <button id="clearBtn" class="btn-danger">Clear</button>
        </div>
      </div>
      <div style="max-height:260px; overflow:auto">
        <table id="logTable" aria-label="Log table">
          <thead>
            <tr>
              <th>Time</th><th>Species</th><th class="mono">Lat</th><th class="mono">Lon</th><th>Acc (m)</th><th>Method</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <details>
        <summary><strong>Settings</strong></summary>
        <div style="margin-top:10px">
          <label>Species list (comma‚Äëseparated). Example: Red‚Äëtailed Hawk, American Kestrel, Turkey Vulture</label>
          <textarea id="speciesInput" rows="3" placeholder="Enter common names‚Ä¶"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="saveSpecies" class="btn-accent">Save species</button>
            <button id="resetSpecies" class="btn-warn">Reset defaults</button>
          </div>
          <div style="margin-top:10px; font-size:12px; color:var(--muted)">GPS is captured each time you log. Accuracy shown above; if it looks high, wait a moment for a better fix.</div>
        </div>
      </details>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <nav class="toolbar">
    <div class="wrap">
      <button id="gpsBtn" class="btn-accent big">üìç Enable GPS</button>
      <button id="undoBtn" class="big">‚Ü∂ Undo</button>
    </div>
  </nav>

  <script>
    // --- State ---
    const DEFAULT_SPECIES = [
      "Red-tailed Hawk","American Kestrel","Turkey Vulture","Red-shouldered Hawk",
      "Northern Harrier","Cooper's Hawk","Bald Eagle","Killdeer"
    ];

    const state = {
      species: loadSpecies(),
      logs: loadLogs(),
      lastFix: null,
      watchId: null,
      counts: {},
      recognizing: false
    };

    function loadSpecies(){
      try{ const s = JSON.parse(localStorage.getItem('speciesList')); if(Array.isArray(s) && s.length) return s; }catch{}
      return DEFAULT_SPECIES;
    }
    function saveSpeciesList(arr){ localStorage.setItem('speciesList', JSON.stringify(arr)); }

    function loadLogs(){
      try{ const l = JSON.parse(localStorage.getItem('birdLogs')); if(Array.isArray(l)) return l; }catch{}
      return [];
    }
    function saveLogs(){ localStorage.setItem('birdLogs', JSON.stringify(state.logs)); }

    // --- UI helpers ---
    const speciesGrid = document.getElementById('speciesGrid');
    const logTableBody = document.querySelector('#logTable tbody');
    const gpsStatusEl = document.getElementById('gpsStatus');
    const accPill = document.getElementById('accPill');
    const toast = document.getElementById('toast');

    function renderSpecies(){
      speciesGrid.innerHTML = '';
      state.counts = {};
      state.species.forEach(name => {
        state.counts[name] = 0;
        const btn = document.createElement('button');
        btn.className = 'species-btn';
        btn.innerHTML = `<span class="species-name">${escapeHtml(name)}</span><span class="count-badge" id="count-${slug(name)}">0</span>`;
        btn.addEventListener('click', () => quickLog(name, 1, 'tap'));
        // long-press to subtract
        let pressTimer = null;
        btn.addEventListener('touchstart', () => { pressTimer = setTimeout(()=> quickLog(name, -1, 'longpress'), 500); }, {passive:true});
        btn.addEventListener('touchend', () => { if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; }});
        speciesGrid.appendChild(btn);
      });
    }

    function renderLogs(){
      logTableBody.innerHTML='';
      state.logs.slice().reverse().forEach(entry => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fmtTime(entry.t)}</td><td>${escapeHtml(entry.species)}</td>`+
          `<td class="mono">${entry.lat?.toFixed?.(5) ?? ''}</td>`+
          `<td class="mono">${entry.lon?.toFixed?.(5) ?? ''}</td>`+
          `<td>${entry.acc ?? ''}</td><td>${entry.method}</td>`;
        logTableBody.appendChild(tr);
      });
    }

    function toastMsg(msg){
      toast.textContent = msg; toast.style.display='block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> toast.style.display='none', 1200);
    }

    function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function fmtTime(iso){ const d=new Date(iso); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

    // --- Geolocation ---
    const gpsBtn = document.getElementById('gpsBtn');
    gpsBtn.addEventListener('click', toggleGPS);

    function toggleGPS(){
      if(state.watchId){
        navigator.geolocation.clearWatch(state.watchId);
        state.watchId = null; state.lastFix = null; gpsStatusEl.textContent = 'off'; accPill.textContent = '¬±‚Äì m';
        gpsBtn.textContent = 'üìç Enable GPS';
        return;
      }
      if(!('geolocation' in navigator)) { alert('Geolocation not supported'); return; }
      state.watchId = navigator.geolocation.watchPosition(pos => {
        state.lastFix = pos;
        gpsStatusEl.textContent = 'on';
        const acc = Math.round(pos.coords.accuracy||0);
        accPill.textContent = `¬±${acc} m`;
      }, err => {
        console.warn(err); toastMsg('GPS error');
      }, { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });
      gpsBtn.textContent = 'üìç Disable GPS';
    }

    // --- Logging ---
    function quickLog(name, delta, method){
      if(delta < 0){
        // find last matching entry to remove
        const idx = state.logs.slice().reverse().findIndex(e=> e.species===name);
        if(idx !== -1){
          const realIdx = state.logs.length - 1 - idx;
          state.logs.splice(realIdx,1); saveLogs(); renderLogs();
          state.counts[name] = Math.max(0, (state.counts[name]||0) - 1);
          updateCountBadge(name);
          toastMsg(`Removed last ${name}`);
        }
        return;
      }
      const fix = state.lastFix?.coords || {};
      const entry = {
        t: new Date().toISOString(),
        species: name,
        lat: typeof fix.latitude==='number'? fix.latitude : null,
        lon: typeof fix.longitude==='number'? fix.longitude : null,
        acc: fix.accuracy ? Math.round(fix.accuracy) : null,
        method
      };
      state.logs.push(entry); saveLogs(); renderLogs();
      state.counts[name] = (state.counts[name]||0) + 1; updateCountBadge(name);
      toastMsg(`${name} logged`);
    }

    function updateCountBadge(name){
      const el = document.getElementById('count-'+slug(name)); if(el) el.textContent = state.counts[name]||0;
    }

    document.getElementById('undoBtn').addEventListener('click', ()=>{
      const last = state.logs.pop(); if(!last){ toastMsg('Nothing to undo'); return; }
      saveLogs(); renderLogs();
      if(last && last.species){ state.counts[last.species] = Math.max(0,(state.counts[last.species]||1)-1); updateCountBadge(last.species); }
      toastMsg('Last entry undone');
    });

    // --- Species editing ---
    const addBtn = document.getElementById('addBtn');
    addBtn.addEventListener('click', ()=>{
      const name = prompt('Species common name');
      if(name && name.trim()){
        state.species.push(name.trim()); saveSpeciesList(state.species); renderSpecies();
      }
    });

    const speciesInput = document.getElementById('speciesInput');
    const saveSpecies = document.getElementById('saveSpecies');
    const resetSpecies = document.getElementById('resetSpecies');

    saveSpecies.addEventListener('click', ()=>{
      const arr = speciesInput.value.split(',').map(s=> s.trim()).filter(Boolean);
      if(arr.length){ state.species = arr; saveSpeciesList(arr); renderSpecies(); toastMsg('Species saved'); }
    });
    resetSpecies.addEventListener('click', ()=>{
      if(confirm('Reset to default species?')){ state.species = DEFAULT_SPECIES.slice(); saveSpeciesList(state.species); renderSpecies(); }
    });

    // preload textarea with current list
    function preloadSpeciesTextarea(){ speciesInput.value = state.species.join(', '); }

    // --- Export / Clear ---
    function logsToCSV(){
      const header = ['date','time','species','latitude','longitude','accuracy_m','method'];
      const rows = state.logs.map(e=>{
        const d = new Date(e.t);
        const date = d.toISOString().slice(0,10);
        const time = d.toTimeString().slice(0,8);
        return [date,time,e.species, e.lat ?? '', e.lon ?? '', e.acc ?? '', e.method];
      });
      return [header].concat(rows).map(r=> r.map(csvEscape).join(',')).join('\n');
    }
    function csvEscape(v){
      const s = String(v);
      return /[",\n]/.test(s) ? '"'+ s.replace(/"/g,'""') +'"' : s;
    }

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const csv = logsToCSV();
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const stamp = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
      a.download = `bird-logs-${stamp}.csv`;
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    });
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(logsToCSV()); toastMsg('CSV copied'); }
      catch{ toastMsg('Copy failed'); }
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(!state.logs.length){ toastMsg('No logs'); return; }
      if(confirm('Clear all logs?')){ state.logs = []; saveLogs(); renderLogs(); toastMsg('Logs cleared'); }
    });

    // --- Voice input (Web Speech API) ---
    const micBtn = document.getElementById('micBtn');
    let recognizer = null;

    function initRecognizer(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ alert('Voice recognition not supported on this browser.'); return null; }
      const r = new SR();
      r.continuous = false; r.lang = 'en-US'; r.interimResults = false; r.maxAlternatives = 3;
      r.onresult = (ev)=>{
        const txt = ev.results[0][0].transcript.trim();
        handleVoice(txt);
      };
      r.onerror = (e)=>{ console.warn('Speech error', e.error); toastMsg('Voice error'); toggleVoice(false); };
      r.onend = ()=>{ toggleVoice(false); };
      return r;
    }

    function handleVoice(spoken){
      const said = spoken.toLowerCase();
      // best match among species list using simple similarity
      let best = null, bestScore = -1;
      for(const s of state.species){
        const score = similarity(s.toLowerCase(), said);
        if(score > bestScore){ bestScore=score; best=s; }
      }
      if(best && bestScore > 0.45){
        quickLog(best, 1, 'voice');
      } else {
        // offer to add as new species
        if(confirm(`Heard: "${spoken}". Add as new species button?`)){
          state.species.push(spoken);
          saveSpeciesList(state.species); renderSpecies(); preloadSpeciesTextarea();
          quickLog(spoken, 1, 'voice-new');
        } else {
          toastMsg('No match');
        }
      }
    }

    function similarity(a,b){
      // Jaccard over trigrams for simplicity
      const ta = trigrams(a), tb = trigrams(b);
      const setA = new Set(ta), setB = new Set(tb);
      let inter = 0; for(const t of setA){ if(setB.has(t)) inter++; }
      const union = setA.size + setB.size - inter; return union? inter/union : 0;
    }
    function trigrams(s){ s = '  '+s+'  '; const v=[]; for(let i=0;i<s.length-2;i++) v.push(s.slice(i,i+3)); return v; }

    function toggleVoice(force){
      if(recognizer==null) recognizer = initRecognizer();
      if(!recognizer) return;
      const on = (typeof force==='boolean')? force : !state.recognizing;
      if(on){ recognizer.start(); micBtn.textContent='üéôÔ∏è Listening‚Ä¶'; state.recognizing=true; }
      else { try{recognizer.stop();}catch{} micBtn.textContent='üéôÔ∏è Voice'; state.recognizing=false; }
    }
    micBtn.addEventListener('click', ()=> toggleVoice());

    // --- Init ---
    function init(){
      renderSpecies(); renderLogs(); preloadSpeciesTextarea();
    }
    init();
  </script>
</body>
</html>
