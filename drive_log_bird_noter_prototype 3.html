<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drive‚ÄëLog Bird Noter (Prototype)</title>
  <style>
    :root {
      --bg: #0b0b0f;
      --card: #14141a;
      --text: #e8e8f0;
      --muted: #a9a9b2;
      --accent: #6ee7ff;
      --danger: #ff6b6b;
      --ok: #7cf29c;
      --btn: #1f1f29;
      --btnHover: #262636;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -20%, #1e1e2a 0%, var(--bg) 60%);
      color: var(--text);
      -webkit-user-select: none; user-select: none;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    header { display:flex; align-items:center; gap:12px; justify-content:space-between; }
    h1 { font-size: 1.3rem; margin: 0; font-weight: 700; letter-spacing: 0.2px; }
    .pill { font-size:.85rem; color: var(--muted); }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; }
    .card { background: var(--card); border: 1px solid #222234; border-radius: 16px; padding: 14px; }
    .grid { display:grid; gap: 10px; grid-template-columns: repeat(3, 1fr); }
    @media (min-width: 680px) { .grid { grid-template-columns: repeat(4, 1fr);} }
    @media (min-width: 920px) { .grid { grid-template-columns: repeat(5, 1fr);} }
    .species-btn {
      background: var(--btn);
      border: 1px solid #2b2b3f;
      border-radius: 16px;
      padding: 18px 10px;
      min-height: 76px;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: .2px;
      text-align: center;
      color: var(--text);
      cursor: pointer;
      transition: transform .04s ease, background .2s ease, border-color .2s ease;
      touch-action: manipulation;
    }
    .species-btn:active { transform: scale(.98); }
    .species-btn:hover { background: var(--btnHover); border-color:#3a3a54; }
    .species-btn small { display:block; font-weight:600; font-size:.72rem; color:var(--muted); margin-top:6px; }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toolbar button, .toolbar input, select {
      background: var(--btn); color: var(--text);
      border: 1px solid #2b2b3f;
      border-radius: 12px; padding: 10px 12px; font-size:.95rem;
    }
    .toolbar button { cursor: pointer; }
    .toolbar button:hover { background: var(--btnHover); }
    #status { font-size:.9rem; color: var(--muted); margin-left:auto; }
    .footer { color: var(--muted); font-size:.8rem; text-align:center; margin-top: 12px; }
    .log-table { width:100%; border-collapse: collapse; margin-top: 8px; font-size:.92rem; }
    .log-table th, .log-table td { border-bottom: 1px solid #26263a; padding: 8px 6px; text-align:left; }
    .log-table th { color: #cfd0ff; font-weight:700; }
    .tag { padding: 2px 8px; border-radius: 999px; border:1px solid #2f2f43; background:#1b1b26; font-size:.75rem; color:#c2c2cf; }
    .ok { color: var(--ok); }
    .warn { color: #ffd166; }
    .danger { color: var(--danger); }
    .row.compact { gap:6px; }
    .counter-badge { display:inline-block; min-width: 26px; height: 24px; padding:0 8px; border-radius: 999px; background:#232336; border:1px solid #2f2f43; line-height:24px; font-size:.85rem; color:#cfd0ff; }
    .sr-only { position:absolute; left:-9999px; }
    .mic-on { outline: 2px solid var(--accent); box-shadow:0 0 0 4px rgba(110,231,255,.1); }
    .note { color:#b7b7c5; font-size:.86rem; }
    .danger-outline { outline: 2px solid rgba(255,107,107,.4); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Drive‚ÄëLog Bird Noter <span class="pill">(Prototype)</span></h1>
      <div id="status">GPS: <span id="gpsStatus">requesting‚Ä¶</span> ‚Ä¢ Records: <span id="recordCount">0</span></div>
    </header>

    <section class="card" aria-label="Quick species buttons">
      <div class="row toolbar">
        <button id="addSpeciesBtn" title="Add a quick button">Ôºã Add Species</button>
        <input id="newSpeciesInput" placeholder="e.g., Red-tailed Hawk" aria-label="New species name" />
        <select id="tapMode">
          <option value="+1">Tap adds +1</option>
          <option value="event">Tap adds event (count=1)</option>
        </select>
        <button id="micBtn" title="Voice (Web Speech API)">üéôÔ∏è Voice</button>
        <button id="exportBtn" title="Download CSV">‚¨áÔ∏é Export CSV</button>
        <button id="clearBtn" title="Clear all records" style="margin-left:auto">üóëÔ∏è Clear</button>
      </div>
      <div class="grid" id="speciesGrid" role="group" aria-label="Species quick buttons"></div>
      <div class="row compact" style="margin-top:10px">
        <span class="note">Tap a button to log species + current GPS + timestamp. Voice recognizes species in your list (adds free‚Äëtext if not matched).</span>
      </div>
    </section>

    <section class="card" aria-label="Recent logs">
      <div class="row" style="justify-content:space-between; align-items: baseline;">
        <h2 style="margin:0; font-size:1.05rem">Recent Records</h2>
        <label class="note"><input type="checkbox" id="showCounts" /> Show per‚Äëspecies counters on buttons</label>
      </div>
      <table class="log-table" id="logTable" aria-describedby="logHelp">
        <thead>
          <tr>
            <th>Time</th>
            <th>Species</th>
            <th>Lat</th>
            <th>Lon</th>
            <th>¬±m</th>
            <th>Mode</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
      <div id="logHelp" class="sr-only">Table of recorded sightings with time, species, latitude, longitude, accuracy, and entry mode.</div>
    </section>

    <div class="footer">Designed for quick, eyes‚Äëoff logging. For safety, only use hands‚Äëfree or with a passenger.</div>
  </div>

<script>
(function(){
  // ---- Storage shim (fixes iOS Safari Private/Files app localStorage crashes) ----
  const memoryStore = (()=>{ const m = new Map(); return { getItem:k=>m.has(k)?m.get(k):null, setItem:(k,v)=>{m.set(k,String(v));}, removeItem:k=>m.delete(k) }; })();
  function storageOK(){ try{ const k='__probe__'; window.localStorage.setItem(k,'1'); window.localStorage.removeItem(k); return true; } catch(e){ return false; } }
  const store = storageOK() ? window.localStorage : memoryStore;
  const usingMemory = store === memoryStore;

  const DEFAULT_SPECIES = [
    "Red-tailed Hawk","American Kestrel","Turkey Vulture","Red-shouldered Hawk","Northern Harrier",
    "Great Horned Owl","Caracara","Black Vulture","Bald Eagle","Osprey"
  ];

  const speciesGrid = document.getElementById('speciesGrid');
  const newSpeciesInput = document.getElementById('newSpeciesInput');
  const addSpeciesBtn = document.getElementById('addSpeciesBtn');
  const exportBtn = document.getElementById('exportBtn');
  const clearBtn = document.getElementById('clearBtn');
  const micBtn = document.getElementById('micBtn');
  const gpsStatusEl = document.getElementById('gpsStatus');
  const recordCountEl = document.getElementById('recordCount');
  const tapModeSel = document.getElementById('tapMode');
  const showCounts = document.getElementById('showCounts');
  const logBody = document.getElementById('logBody');

  let db = load('db');
  if(!db){
    const sp = load('species') || DEFAULT_SPECIES;
    db = { species: sp, records: [] };
    // best-effort save; ignore failures
    try { save('species', sp); save('db', db); } catch(_){}
  }

  let lastPos = null; let watchId = null; let speech = null; let micOn = false;
  startGPS();
  // If storage is memory-only, let the user know (iOS Private Mode / Files viewer)
  if(usingMemory){
    const status = document.getElementById('status');
    const warn = document.createElement('span');
    warn.className = 'warn';
    warn.style.marginLeft = '8px';
    warn.textContent = 'Storage: memory-only (changes vanish if you close tab)';
    status.appendChild(warn);
  }
  renderSpecies();
  renderTable();
  updateCountsOnButtons();

  addSpeciesBtn.addEventListener('click', () => {
    const name = (newSpeciesInput.value || '').trim();
    if(!name) { pulse(newSpeciesInput); return; }
    if(db.species.includes(name)) { pulse(newSpeciesInput); return; }
    db.species.push(name); save('species', db.species); save('db', db); newSpeciesInput.value='';
    renderSpecies();
  });

  showCounts.addEventListener('change', updateCountsOnButtons);

  exportBtn.addEventListener('click', () => {
    const csv = toCSV(db.records);
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const date = new Date();
    a.href = url; a.download = `drive-log-birds_${date.toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  clearBtn.addEventListener('click', () => {
    if(!confirm('Clear all records?')) return;
    db.records = []; save('db', db); renderTable(); updateCountsOnButtons();
  });

  micBtn.addEventListener('click', toggleMic);

  function renderSpecies(){
    speciesGrid.innerHTML = '';
    db.species.forEach((sp, idx) => {
      const btn = document.createElement('button');
      btn.className = 'species-btn';
      btn.innerHTML = `<span>${escapeHtml(sp)}</span><small class="hint">tap to log</small>`;
      btn.addEventListener('click', () => logSpecies(sp, 'tap'));
      btn.addEventListener('contextmenu', (e) => { e.preventDefault(); editSpecies(idx, sp, btn); });
      speciesGrid.appendChild(btn);
    });
    updateCountsOnButtons();
  }

  function editSpecies(idx, sp, el){
    const action = prompt(`Edit species or type DELETE to remove:\n${sp}` , sp);
    if(action === null) return;
    if(action.trim().toUpperCase() === 'DELETE'){
      db.species.splice(idx,1); save('species', db.species); save('db', db); renderSpecies(); return;
    }
    const val = action.trim();
    if(!val) return;
    db.species[idx] = val; save('species', db.species); save('db', db); renderSpecies();
  }

  function logSpecies(species, mode){
    if(!lastPos){ pulse(gpsStatusEl); }
    const now = new Date();
    const rec = {
      ts: now.toISOString(),
      species,
      lat: lastPos?.coords?.latitude ?? null,
      lon: lastPos?.coords?.longitude ?? null,
      acc_m: lastPos?.coords?.accuracy ?? null,
      method: mode,
    };

    if(tapModeSel.value === '+1'){
      // aggregate count per species & minute if same minute and ~same location
      // but also push atomic entry for auditing
      db.records.push({...rec, count: 1});
    } else {
      db.records.push({...rec, count: 1});
    }

    save('db', db);
    renderTable();
    updateCountsOnButtons();
    flashOK();
  }

  function renderTable(){
    recordCountEl.textContent = String(db.records.length);
    const rows = db.records.slice(-100).reverse().map((r, i) => {
      const dt = new Date(r.ts);
      const time = dt.toLocaleString();
      const acc = r.acc_m != null ? Math.round(r.acc_m) : '';
      const lat = r.lat != null ? r.lat.toFixed(5) : '';
      const lon = r.lon != null ? r.lon.toFixed(5) : '';
      return `<tr>
        <td><span title="${dt.toISOString()}">${time}</span></td>
        <td>${escapeHtml(r.species)}${r.count>1?` <span class="tag">x${r.count}</span>`:''}</td>
        <td>${lat}</td>
        <td>${lon}</td>
        <td>${acc}</td>
        <td>${r.method}</td>
        <td><button data-idx="${db.records.length-1 - i}" class="miniDel" title="Delete">‚úï</button></td>
      </tr>`;
    }).join('');
    logBody.innerHTML = rows || `<tr><td colspan="7" class="note">No records yet.</td></tr>`;
    document.querySelectorAll('.miniDel').forEach(btn => btn.addEventListener('click', (e)=>{
      const idx = +e.currentTarget.getAttribute('data-idx');
      db.records.splice(idx,1); save('db', db); renderTable(); updateCountsOnButtons();
    }));
  }

  function updateCountsOnButtons(){
    const counts = {};
    db.records.forEach(r => counts[r.species] = (counts[r.species]||0) + (r.count||1));
    const show = showCounts.checked;
    document.querySelectorAll('.species-btn').forEach((btn, i) => {
      const sp = db.species[i];
      const c = counts[sp] || 0;
      btn.querySelector('.hint').innerHTML = show ? `<span class="counter-badge" title="Logged count">${c}</span>` : 'tap to log';
    });
  }

  function toCSV(records){
    const header = ['timestamp_iso','species','lat','lon','accuracy_m','count','method'];
    const lines = [header.join(',')];
    records.forEach(r => {
      const row = [r.ts, r.species, r.lat??'', r.lon??'', r.acc_m??'', r.count??1, r.method];
      lines.push(row.map(csvEscape).join(','));
    });
    return lines.join('\n');
  }

  function csvEscape(v){
    if(v===null || v===undefined) return '';
    const s = String(v);
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function load(key){
    try { return JSON.parse(store.getItem('driveLogBirds:'+key)); } catch(e){ return null; }
  } catch(e){ return null; }
  }
  function save(key, val){
    try { store.setItem('driveLogBirds:'+key, JSON.stringify(val)); }
    catch(e){ /* fall back is already active; ignore quota/security errors */ }
  }

  function startGPS(){
    if(!('geolocation' in navigator)) { gpsStatusEl.textContent = 'unavailable'; gpsStatusEl.className='danger'; return; }
    gpsStatusEl.textContent = 'requesting‚Ä¶';
    watchId = navigator.geolocation.watchPosition(pos => {
      lastPos = pos;
      const acc = Math.round(pos.coords.accuracy);
      gpsStatusEl.textContent = `${acc} m`;
      gpsStatusEl.className = acc<20? 'ok' : (acc<60? 'warn' : '');
    }, err => {
      gpsStatusEl.textContent = err.message;
      gpsStatusEl.className='danger';
      // Geolocation requires HTTPS or localhost in most browsers
      if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
        gpsStatusEl.textContent += ' (tip: open this over HTTPS for GPS)';
      }
    }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 8000 });
  }

  function toggleMic(){
    if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
      alert('Speech recognition not supported in this browser. Try Chrome on Android or desktop.');
      return;
    }
    if(!speech){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      speech = new SR();
      speech.lang = 'en-US';
      speech.interimResults = false;
      speech.continuous = true;
      speech.onresult = (ev) => {
        for(let i=ev.resultIndex; i<ev.results.length; i++){
          if(ev.results[i].isFinal){
            const said = ev.results[i][0].transcript.trim();
            handleTranscript(said);
          }
        }
      };
      speech.onerror = (e) => { console.warn('Speech error', e.error); pulse(micBtn); };
      speech.onend = () => { if(micOn) tryStart(); };
    }
    micOn = !micOn;
    micBtn.classList.toggle('mic-on', micOn);
    micBtn.textContent = micOn ? 'üéôÔ∏è Listening‚Ä¶' : 'üéôÔ∏è Voice';
    if(micOn) tryStart(); else tryStop();

    function tryStart(){ try { speech.start(); } catch(e){ /* already started */ } }
    function tryStop(){ try { speech.stop(); } catch(e){ /* ignore */ } }
  }

  function handleTranscript(text){
    const cleaned = text.toLowerCase().replace(/[^a-z\-\s]/g,'').replace(/ +/g,' ').trim();
    if(!cleaned) return;

    // Fuzzy match to known species
    const idx = bestSpeciesMatch(cleaned);
    if(idx>=0){
      logSpecies(db.species[idx], 'voice');
    } else {
      // Save as free text in species field so you can reconcile later
      logSpecies(text, 'voice-free');
    }
  }

  function bestSpeciesMatch(s){
    let best = -1, bestScore = 0;
    const norm = (x)=> x.toLowerCase().replace(/[^a-z\-\s]/g,'').replace(/ +/g,' ').trim();
    const words = new Set(s.split(' '));
    db.species.forEach((sp, i) => {
      const n = norm(sp);
      const wsp = new Set(n.split(' '));
      let overlap = 0; wsp.forEach(w=>{ if(words.has(w)) overlap++; });
      let score = overlap / Math.max(1, wsp.size);
      if(n===s) score += 0.5; // exact phrase bonus
      if(score > bestScore && score >= 0.5) { bestScore = score; best = i; }
    });
    return best;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  function pulse(el){
    el.classList.add('danger-outline');
    setTimeout(()=> el.classList.remove('danger-outline'), 500);
  }

  function flashOK(){
    document.body.animate([{backgroundColor:'rgba(124,242,156,.08)'},{backgroundColor:'transparent'}], {duration:300});
  }
})();
</script>
</body>
</html>
